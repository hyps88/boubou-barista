<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BouBou Barista | Smart Menu</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #5d4037; --bg: #fdfaf7; --text: #2d2d2d; --border: #ece0d1; --closed-bg: #ececec; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 20px; min-height: 100vh; align-items: center; transition: background 0.5s; }
        body.shop-closed { background: var(--closed-bg); }
        .card { max-width: 420px; width: 100%; background: white; padding: 40px; border-radius: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.04); border: 1px solid var(--border); }
        h1 { font-family: 'Playfair Display'; color: var(--accent); text-align: center; margin: 0; font-size: 2.2rem; }
        .subtitle { text-align: center; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; opacity: 0.5; margin-bottom: 20px; }
        .group { margin-bottom: 18px; }
        label { display: block; font-size: 0.75rem; font-weight: 600; margin-bottom: 8px; color: var(--accent); text-transform: uppercase; }
        select, input, textarea { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 12px; font-size: 1rem; box-sizing: border-box; outline: none; background: #fff; font-family: 'Inter', sans-serif; }
        .btn { width: 100%; padding: 18px; background: var(--accent); color: white; border: none; border-radius: 15px; font-weight: 600; font-size: 1.1rem; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn:disabled { background: #999; }
        #tracking { display: none; text-align: center; }
        .step { margin: 15px 0; opacity: 0.1; transition: 0.5s; font-weight: 600; }
        .step.active { opacity: 1; color: var(--accent); }
    </style>
</head>
<body>

<div class="card">
    <div id="order-form">
        <h1>BouBou Barista</h1>
        <div id="status-label" class="subtitle">Loading...</div>

        <div class="group"><label>Name</label><input type="text" id="name" placeholder="Enter name"></div>
        
        <div class="group">
            <label>Drink</label>
            <select id="drink-select" onchange="filterFlavors()"></select>
        </div>

        <div class="group">
            <label>Flavor</label>
            <select id="flavor-select"></select>
        </div>

        <div class="group">
            <label>Size</label>
            <select id="size-select"></select>
        </div>

        <div class="group"><label>Notes</label><textarea id="notes" rows="2"></textarea></div>

        <button id="main-btn" class="btn" onclick="sendOrder()">Place Order</button>
    </div>

    <div id="tracking">
        <h2 style="font-family: 'Playfair Display'; color: var(--accent);">Brewing...</h2>
        <div id="s1" class="step">Grinding beans...</div>
        <div id="s2" class="step">Extraction in progress...</div>
        <div id="s3" class="step">Steaming milk...</div>
        <div id="s4" class="step">Coming to you!</div>
        <button onclick="location.reload()" style="background:none; border:none; text-decoration:underline; cursor:pointer; margin-top:30px; color:var(--accent);">Back to Menu</button>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyvcyZyGbCjKm3bZwJp8mUnKpY3axqNDM5up3v2C6EkRPkNuOj_pZfPuV1gGrpYEc8T/exec";
    let fullMenu = [];

    async function init() {
        const res = await fetch(SCRIPT_URL);
        const data = await res.json();
        fullMenu = data.menu;

        // Set Shop Status
        const isOpen = data.status.toLowerCase() === 'open';
        document.getElementById('status-label').innerText = isOpen ? "Open for service" : "Kitchen Closed";
        if(!isOpen) {
            document.body.classList.add('shop-closed');
            document.getElementById('main-btn').disabled = true;
            document.getElementById('main-btn').innerText = "Closed";
        }

        // Populate Initial Menus
        populateSelect('drink-select', 'Drink');
        populateSelect('size-select', 'Size');
        
        // Run initial flavor filter
        filterFlavors();
    }

    function populateSelect(id, category) {
        const select = document.getElementById(id);
        fullMenu.filter(row => row[0] === category).forEach(row => {
            const opt = document.createElement('option');
            opt.value = row[1];
            opt.text = row[1];
            if(row[2] === 'OOS') opt.disabled = true;
            select.add(opt);
        });
    }

    function filterFlavors() {
        const selectedDrink = document.getElementById('drink-select').value;
        const flavorSelect = document.getElementById('flavor-select');
        flavorSelect.innerHTML = ''; // Clear flavors

        // Filter Logic: Show if Link is "All" or includes the selected Drink
        const allowedFlavors = fullMenu.filter(row => {
            if (row[0] !== 'Flavor') return false;
            const links = row[3] ? row[3].toString().toLowerCase() : "all";
            return links.includes("all") || links.includes(selectedDrink.toLowerCase());
        });

        allowedFlavors.forEach(row => {
            const opt = document.createElement('option');
            opt.value = row[1];
            opt.text = row[2] === 'OOS' ? `${row[1]} (OOS)` : row[1];
            if(row[2] === 'OOS') opt.disabled = true;
            flavorSelect.add(opt);
        });
    }

    async function sendOrder() {
        const btn = document.getElementById('main-btn');
        btn.innerText = "Sending..."; btn.disabled = true;

        const payload = {
            name: document.getElementById('name').value || "BouBou",
            drink: document.getElementById('drink-select').value,
            flavor: document.getElementById('flavor-select').value,
            size: document.getElementById('size-select').value,
            notes: document.getElementById('notes').value
        };

        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });

        document.getElementById('order-form').style.display = 'none';
        document.getElementById('tracking').style.display = 'block';
        ['s1','s2','s3','s4'].forEach((id, i) => setTimeout(() => document.getElementById(id).classList.add('active'), i * 3500));
    }

    init();
</script>
</body>
</html>
